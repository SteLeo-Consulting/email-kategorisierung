// =============================================================================
// Prisma Schema for Email Kategorisierung System
// Database: PostgreSQL on Neon (Free Tier)
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// USERS
// =============================================================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  connections Connection[]
  categories  Category[]
  auditLogs   AuditLog[]

  @@map("users")
}

// =============================================================================
// CONNECTIONS (Email Provider Connections)
// =============================================================================
enum Provider {
  GMAIL
  OUTLOOK
  IMAP
}

enum ConnectionStatus {
  ACTIVE
  INACTIVE
  ERROR
  NEEDS_REAUTH
}

model Connection {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  provider    Provider
  email       String
  displayName String?          @map("display_name")
  status      ConnectionStatus @default(ACTIVE)
  lastSyncAt  DateTime?        @map("last_sync_at")
  lastError   String?          @map("last_error")
  settings    Json?            // Provider-specific settings (e.g., IMAP host/port)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  oauthToken        OAuthToken?
  imapCredential    IMAPCredential?
  labelMappings     LabelMapping[]
  processedMessages ProcessedMessage[]

  @@unique([userId, provider, email])
  @@map("connections")
}

// =============================================================================
// OAUTH TOKENS (Gmail, Outlook)
// =============================================================================
model OAuthToken {
  id           String    @id @default(cuid())
  connectionId String    @unique @map("connection_id")
  accessToken  String    @map("access_token") @db.Text // Encrypted
  refreshToken String?   @map("refresh_token") @db.Text // Encrypted
  expiresAt    DateTime? @map("expires_at")
  scope        String?
  tokenType    String?   @map("token_type")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("oauth_tokens")
}

// =============================================================================
// IMAP CREDENTIALS (Strato, other IMAP providers)
// =============================================================================
model IMAPCredential {
  id           String   @id @default(cuid())
  connectionId String   @unique @map("connection_id")
  host         String
  port         Int      @default(993)
  secure       Boolean  @default(true)
  username     String
  password     String   @db.Text // Encrypted
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("imap_credentials")
}

// =============================================================================
// CATEGORIES (Email Categories)
// =============================================================================
model Category {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  name         String   // Display name (e.g., "Rechnung")
  internalCode String   @map("internal_code") // System code (e.g., "INVOICE")
  description  String?
  color        String   @default("#6366f1") // Hex color for UI
  icon         String?  // Optional icon name
  isSystem     Boolean  @default(false) @map("is_system") // Built-in categories
  isActive     Boolean  @default(true) @map("is_active")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  rules             Rule[]
  labelMappings     LabelMapping[]
  processedMessages ProcessedMessage[]

  @@unique([userId, internalCode])
  @@map("categories")
}

// =============================================================================
// RULES (Classification Rules)
// =============================================================================
enum RuleType {
  KEYWORD       // Simple keyword match
  REGEX         // Regular expression
  SENDER        // Sender email/domain match
  SUBJECT       // Subject line match
  COMBINED      // Multiple conditions
}

enum RuleField {
  FROM
  TO
  SUBJECT
  BODY
  ANY
}

model Rule {
  id         String    @id @default(cuid())
  categoryId String    @map("category_id")
  name       String
  type       RuleType
  field      RuleField @default(ANY)
  pattern    String    // The actual pattern/keyword
  caseSensitive Boolean @default(false) @map("case_sensitive")
  priority   Int       @default(0) // Higher = checked first
  confidence Float     @default(0.85) // Confidence when rule matches
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("rules")
}

// =============================================================================
// LABEL MAPPINGS (Provider-specific label configuration)
// =============================================================================
enum LabelType {
  LABEL     // Gmail labels, generic labels
  CATEGORY  // Outlook categories
  FOLDER    // Move to folder
  FLAG      // IMAP flags/keywords
}

model LabelMapping {
  id            String    @id @default(cuid())
  categoryId    String    @map("category_id")
  connectionId  String    @map("connection_id")
  providerLabel String    @map("provider_label") // Gmail label ID, Outlook category, folder name
  labelType     LabelType @map("label_type")
  autoCreate    Boolean   @default(true) @map("auto_create") // Create if not exists
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([categoryId, connectionId])
  @@map("label_mappings")
}

// =============================================================================
// PROCESSED MESSAGES (Tracking processed emails)
// =============================================================================
model ProcessedMessage {
  id             String    @id @default(cuid())
  connectionId   String    @map("connection_id")
  messageId      String    @map("message_id") // Provider's message ID
  threadId       String?   @map("thread_id")
  categoryId     String?   @map("category_id")
  confidence     Float
  labelApplied   String?   @map("label_applied")
  labelType      LabelType? @map("label_type")
  classifiedBy   String    @default("rules") @map("classified_by") // "rules" or "llm"
  rationale      String?   // Short explanation
  needsReview    Boolean   @default(false) @map("needs_review")
  reviewedAt     DateTime? @map("reviewed_at")
  reviewedAction String?   @map("reviewed_action") // "approved", "changed", "rejected"
  emailSubject   String?   @map("email_subject") // For audit/display (optional)
  emailFrom      String?   @map("email_from")
  emailDate      DateTime? @map("email_date")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  category   Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([connectionId, messageId])
  @@index([connectionId, createdAt])
  @@index([needsReview])
  @@map("processed_messages")
}

// =============================================================================
// AUDIT LOG
// =============================================================================
enum AuditAction {
  CONNECTION_CREATED
  CONNECTION_UPDATED
  CONNECTION_DELETED
  CONNECTION_ERROR
  CATEGORY_CREATED
  CATEGORY_UPDATED
  CATEGORY_DELETED
  RULE_CREATED
  RULE_UPDATED
  RULE_DELETED
  LABEL_MAPPING_CREATED
  LABEL_MAPPING_UPDATED
  EMAIL_CLASSIFIED
  EMAIL_LABELED
  EMAIL_REVIEWED
  CRON_RUN_STARTED
  CRON_RUN_COMPLETED
  CRON_RUN_FAILED
  USER_LOGIN
  USER_LOGOUT
  SETTINGS_CHANGED
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?     @map("user_id")
  action     AuditAction
  entityType String?     @map("entity_type") // "connection", "category", etc.
  entityId   String?     @map("entity_id")
  details    Json?       // Additional context
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  createdAt  DateTime    @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_log")
}

// =============================================================================
// SYSTEM SETTINGS (Global configuration)
// =============================================================================
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// =============================================================================
// LLM PROVIDERS (AI API Connections)
// =============================================================================
enum LLMProviderType {
  MISTRAL
  OPENAI
  ANTHROPIC
  GROQ
}

enum LLMProviderStatus {
  ACTIVE
  ERROR
  UNCHECKED
}

model LLMProvider {
  id        String            @id @default(cuid())
  userId    String            @map("user_id")
  name      String            // Display name
  provider  LLMProviderType
  apiKey    String            @map("api_key") @db.Text // Encrypted
  model     String            // Model name (e.g., mistral-large-latest)
  isDefault Boolean           @default(false) @map("is_default")
  status    LLMProviderStatus @default(UNCHECKED)
  lastError String?           @map("last_error")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  @@map("llm_providers")
}
