generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  image       String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  auditLogs   AuditLog[]
  categories  Category[]
  connections Connection[]

  @@map("users")
}

model Connection {
  id                String             @id @default(cuid())
  userId            String             @map("user_id")
  provider          Provider
  email             String
  displayName       String?            @map("display_name")
  status            ConnectionStatus   @default(ACTIVE)
  lastSyncAt        DateTime?          @map("last_sync_at")
  lastError         String?            @map("last_error")
  settings          Json?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  imapCredential    IMAPCredential?
  labelMappings     LabelMapping[]
  oauthToken        OAuthToken?
  processedMessages ProcessedMessage[]

  @@unique([userId, provider, email])
  @@map("connections")
}

model OAuthToken {
  id           String     @id @default(cuid())
  connectionId String     @unique @map("connection_id")
  accessToken  String     @map("access_token")
  refreshToken String?    @map("refresh_token")
  expiresAt    DateTime?  @map("expires_at")
  scope        String?
  tokenType    String?    @map("token_type")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("oauth_tokens")
}

model IMAPCredential {
  id           String     @id @default(cuid())
  connectionId String     @unique @map("connection_id")
  host         String
  port         Int        @default(993)
  secure       Boolean    @default(true)
  username     String
  password     String
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("imap_credentials")
}

model Category {
  id                String             @id @default(cuid())
  userId            String             @map("user_id")
  name              String
  internalCode      String             @map("internal_code")
  description       String?
  color             String             @default("#6366f1")
  icon              String?
  isSystem          Boolean            @default(false) @map("is_system")
  isActive          Boolean            @default(true) @map("is_active")
  sortOrder         Int                @default(0) @map("sort_order")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  labelMappings     LabelMapping[]
  processedMessages ProcessedMessage[]
  rules             Rule[]

  @@unique([userId, internalCode])
  @@map("categories")
}

model Rule {
  id            String    @id @default(cuid())
  categoryId    String    @map("category_id")
  name          String
  type          RuleType
  field         RuleField @default(ANY)
  pattern       String
  caseSensitive Boolean   @default(false) @map("case_sensitive")
  priority      Int       @default(0)
  confidence    Float     @default(0.85)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  category      Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("rules")
}

model LabelMapping {
  id            String     @id @default(cuid())
  categoryId    String     @map("category_id")
  connectionId  String     @map("connection_id")
  providerLabel String     @map("provider_label")
  labelType     LabelType  @map("label_type")
  autoCreate    Boolean    @default(true) @map("auto_create")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  category      Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  connection    Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([categoryId, connectionId])
  @@map("label_mappings")
}

model ProcessedMessage {
  id             String     @id @default(cuid())
  connectionId   String     @map("connection_id")
  messageId      String     @map("message_id")
  threadId       String?    @map("thread_id")
  categoryId     String?    @map("category_id")
  confidence     Float
  labelApplied   String?    @map("label_applied")
  labelType      LabelType? @map("label_type")
  classifiedBy   String     @default("rules") @map("classified_by")
  rationale      String?
  needsReview    Boolean    @default(false) @map("needs_review")
  reviewedAt     DateTime?  @map("reviewed_at")
  reviewedAction String?    @map("reviewed_action")
  emailSubject   String?    @map("email_subject")
  emailFrom      String?    @map("email_from")
  emailDate      DateTime?  @map("email_date")
  createdAt      DateTime   @default(now()) @map("created_at")
  category       Category?  @relation(fields: [categoryId], references: [id])
  connection     Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, messageId])
  @@index([connectionId, createdAt])
  @@index([needsReview])
  @@map("processed_messages")
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?     @map("user_id")
  action     AuditAction
  entityType String?     @map("entity_type")
  entityId   String?     @map("entity_id")
  details    Json?
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  createdAt  DateTime    @default(now()) @map("created_at")
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_log")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model LLMProvider {
  id        String            @id @default(cuid())
  userId    String            @map("user_id")
  name      String
  provider  LLMProviderType
  apiKey    String            @map("api_key")
  model     String
  isDefault Boolean           @default(false) @map("is_default")
  status    LLMProviderStatus @default(UNCHECKED)
  lastError String?           @map("last_error")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  @@map("llm_providers")
}

enum Provider {
  GMAIL
  OUTLOOK
  IMAP
}

enum ConnectionStatus {
  ACTIVE
  INACTIVE
  ERROR
  NEEDS_REAUTH
}

enum RuleType {
  KEYWORD
  REGEX
  SENDER
  SUBJECT
  COMBINED
}

enum RuleField {
  FROM
  TO
  SUBJECT
  BODY
  ANY
}

enum LabelType {
  LABEL
  CATEGORY
  FOLDER
  FLAG
}

enum AuditAction {
  CONNECTION_CREATED
  CONNECTION_UPDATED
  CONNECTION_DELETED
  CONNECTION_ERROR
  CATEGORY_CREATED
  CATEGORY_UPDATED
  CATEGORY_DELETED
  RULE_CREATED
  RULE_UPDATED
  RULE_DELETED
  LABEL_MAPPING_CREATED
  LABEL_MAPPING_UPDATED
  EMAIL_CLASSIFIED
  EMAIL_LABELED
  EMAIL_REVIEWED
  CRON_RUN_STARTED
  CRON_RUN_COMPLETED
  CRON_RUN_FAILED
  USER_LOGIN
  USER_LOGOUT
  SETTINGS_CHANGED
}

enum LLMProviderType {
  MISTRAL
  OPENAI
  ANTHROPIC
  GROQ
}

enum LLMProviderStatus {
  ACTIVE
  ERROR
  UNCHECKED
}
